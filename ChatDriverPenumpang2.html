<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat Driver-Penumpang</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      position: relative;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #f0f0f0;
      padding-bottom: 80px;
    }

    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 18px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .sent {
      background: #dcf8c6;
      align-self: flex-end;
      margin-left: 30%;
    }

    .received {
      background: #ffffff;
      align-self: flex-start;
      margin-right: 30%;
      border: 1px solid #ddd;
    }

    #message-form {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ccc;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      box-sizing: border-box;
    }

    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
    }

    #send-button {
      margin-left: 10px;
      padding: 10px 20px;
      background: #128C7E;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }

    #status {
      padding: 8px;
      background: #ece5dd;
      text-align: center;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="status">Memuat chat...</div>
  <div id="chat-container">
    <div id="messages"></div>
  </div>

  <form id="message-form">
    <input type="text" id="message-input" placeholder="Ketik pesan..." autocomplete="off" />
    <button type="submit" id="send-button">Kirim</button>
  </form>

  <script>
    const params = new URLSearchParams(window.location.search);

    const firebaseConfig = {
      apiKey: params.get("apiKey"),
      authDomain: params.get("authDomain"),
      databaseURL: params.get("databaseURL"),
      projectId: params.get("projectId"),
      storageBucket: params.get("storageBucket"),
      messagingSenderId: params.get("messagingSenderId"),
      appId: params.get("appId")
    };

    const orderId = params.get("order_id");
    const userType = params.get("user_type"); // 'driver' / 'penumpang'
    const userId = params.get("user_id");
    const userName = params.get("user_name") || userType;

    if (!firebaseConfig.apiKey || !orderId || !userType || !userId) {
      document.getElementById("status").innerText = "Parameter tidak lengkap!";
      throw new Error("Parameter Firebase atau user tidak lengkap");
    }

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const chatRef = database.ref(`chats/${orderId}`);
    const statusRef = database.ref(`status/${orderId}/${userType}`);
    const messagesDiv = document.getElementById("messages");
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");
    const statusDiv = document.getElementById("status");

    function displayMessage(sender, text, timestamp, isSent) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isSent ? "sent" : "received"}`;

      const senderSpan = document.createElement("strong");
      senderSpan.textContent = sender + ": ";

      const textSpan = document.createElement("span");
      textSpan.textContent = text;

      const timeSpan = document.createElement("div");
      timeSpan.style.fontSize = "0.75em";
      timeSpan.style.color = "#666";
      timeSpan.textContent = new Date(timestamp).toLocaleTimeString([], {
        hour: '2-digit', minute: '2-digit'
      });

      messageDiv.appendChild(senderSpan);
      messageDiv.appendChild(textSpan);
      messageDiv.appendChild(timeSpan);

      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    messageForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;

      const data = {
        sender: userType,
        senderId: userId,
        text: text,
        timestamp: Date.now()
      };

      chatRef.push(data).then(() => {
        messageInput.value = "";
        statusRef.set({
          lastActive: Date.now(),
          isOnline: true
        });
      });
    });

    chatRef.on("child_added", (snap) => {
  const msg = snap.val();
  const isSent = msg.senderId === userId;
  const senderName = msg.senderName || (msg.sender === "driver" ? "Driver" : "Penumpang");

  displayMessage(senderName, msg.text, msg.timestamp, isSent);

  if (!isSent && window.AppInventor && window.AppInventor.setWebViewString) {
    const notif = {
      from: senderName,
      message: msg.text,
      timestamp: msg.timestamp
    };
    window.AppInventor.setWebViewString(JSON.stringify(notif));
  }
});

    function updateOnlineStatus() {
      statusRef.set({
        lastActive: Date.now(),
        isOnline: true
      });

      window.addEventListener("beforeunload", () => {
        statusRef.update({ isOnline: false });
      });
    }

    const lawan = userType === "driver" ? "penumpang" : "driver";
    const otherStatusRef = database.ref(`status/${orderId}/${lawan}`);
    otherStatusRef.on("value", (snap) => {
      const val = snap.val();
      if (val && val.lastActive) {
        const online = Date.now() - val.lastActive < 5 * 60 * 1000;
        statusDiv.textContent = online ? "Online" : "Offline";
      }
    });

    updateOnlineStatus();
    setInterval(updateOnlineStatus, 60000);
    statusDiv.textContent = "Chat siap";
  </script>
</body>
</html>
