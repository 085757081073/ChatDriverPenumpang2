<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat Driver-Penumpang</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #f0f0f0;
    }
    .message {
      margin-bottom: 10px;
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .sent {
      background: #dcf8c6;
      align-self: flex-end;
      margin-left: 30%;
    }
    .received {
      background: #ffffff;
      align-self: flex-start;
      margin-right: 30%;
      border: 1px solid #ddd;
    }
    #message-form {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ccc;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
    }
    #send-button {
      margin-left: 10px;
      padding: 10px 20px;
      background: #128C7E;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }
    #status {
      padding: 8px;
      background: #ece5dd;
      text-align: center;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="status">Memuat chat...</div>
  <div id="chat-container">
    <div id="messages"></div>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="Ketik pesan..." autocomplete="off">
      <button type="submit" id="send-button">Kirim</button>
    </form>
  </div>

  <script>
    // Konfigurasi Firebase Web (PASTIKAN appId: WEB, bukan android)
    const firebaseConfig = {
      apiKey: "AIzaSyAFWLUF2aH-lD6UTofpRsy1rXbBrLHTag",
      authDomain: "chatting-87e87.firebaseapp.com",
      databaseURL: "https://chatting-87e87-default-rtdb.firebaseio.com/",
      projectId: "chatting-87e87",
      storageBucket: "chatting-87e87.appspot.com",
      messagingSenderId: "240910634931",
      appId: "1:240910634931:web:49aa4b9a0659d9115045c6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ambil parameter dari URL
    const params = new URLSearchParams(location.search);
    const orderId = params.get("order_id");
    const userType = params.get("user_type"); // 'driver' atau 'penumpang'
    const userId = params.get("user_id");

    if (!orderId || !userType || !userId) {
      document.getElementById('status').textContent = 'Parameter tidak lengkap!';
      throw new Error("Parameter wajib: order_id, user_type, user_id");
    }

    const messagesDiv = document.getElementById("messages");
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");
    const statusDiv = document.getElementById("status");

    const chatRef = db.ref("chats/" + orderId);
    const statusRef = db.ref("status/" + orderId + "/" + userType);
    const otherUser = userType === "driver" ? "penumpang" : "driver";
    const otherStatusRef = db.ref("status/" + orderId + "/" + otherUser);

    // Tampilkan pesan
    function showMessage(sender, text, timestamp, isSent) {
      const div = document.createElement("div");
      div.className = "message " + (isSent ? "sent" : "received");

      const bold = document.createElement("b");
      bold.textContent = sender + ": ";
      div.appendChild(bold);

      div.appendChild(document.createTextNode(text));

      const time = document.createElement("div");
      time.style.fontSize = "0.75em";
      time.style.color = "#888";
      time.textContent = formatTime(timestamp);
      div.appendChild(time);

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Kirim pesan
    messageForm.addEventListener("submit", function(e) {
      e.preventDefault();
      const msg = messageInput.value.trim();
      if (msg) {
        const data = {
          sender: userType,
          senderId: userId,
          text: msg,
          timestamp: Date.now()
        };
        chatRef.push(data).then(() => {
          messageInput.value = "";
          statusRef.set({
            isOnline: true,
            lastActive: Date.now()
          });
        });
      }
    });

    // Tampilkan pesan baru
    chatRef.on("child_added", function(snapshot) {
      const msg = snapshot.val();
      const sent = msg.senderId === userId;
      const senderName = msg.sender === "driver" ? "Driver" : "Penumpang";
      showMessage(senderName, msg.text, msg.timestamp, sent);
    });

    // Cek status lawan bicara
    otherStatusRef.on("value", function(snapshot) {
      const stat = snapshot.val();
      if (stat) {
        const online = stat.isOnline && (Date.now() - stat.lastActive < 300000);
        statusDiv.textContent = online ? "Online" : "Offline";
      }
    });

    // Update status online berkala
    function updateStatusOnline() {
      statusRef.set({
        isOnline: true,
        lastActive: Date.now()
      });
    }

    updateStatusOnline();
    setInterval(updateStatusOnline, 60000);

    // Saat keluar/tab ditutup
    window.addEventListener("beforeunload", function() {
      statusRef.update({ isOnline: false });
    });
  </script>
</body>
</html>